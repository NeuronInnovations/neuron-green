<script type="text/html" data-template-name="buyer config">

    <div class="form-row">
        <label for="node-input-name"> <span>Name</span></label>
        <input type="text" id="node-input-name" placeholder="Node name">
    </div>

    <div class="form-row">
        <label for="node-input-smartContract"><i class="fa fa-file-contract"></i> <span>Smart Contract</span></label>
        <select id="node-input-smartContract">
            <option value="jetvision" selected>JETVISION DEMO</option>
            <option value="chat">P2P CHAT DEMO</option>
            <option value="challenges">DEVELOPER OPEN CHALLENGES</option>
           <!-- <option value="Weather">Weather</option> -->

        </select>
    </div>

    <div class="form-row">
        <label for="node-input-deviceType"><span>Device Type</span></label>
        <input type="text" id="node-input-deviceType" placeholder="Enter Device Type e.g Cloud, Edge">
    </div>
    <div class="form-row">
        <label> <span>Seller EVM Addresses</span></label>
        <input type="hidden" id="node-input-sellerEvmAddress" />
        <button type="button" id="select-sellers-btn" class="red-ui-button">Select Sellers</button>
    </div>
   <!-- <div class="form-row">
        <label for="node-input-sellerEvmAddress"><i class="fa fa-hard-drive"></i> <span>Seller EVM Address</span></label>
        <select id="node-input-sellerEvmAddress" multiple size="5" style="width: 100%;">
            <option value="">Loading...</option>
        </select>
    </div>-->
    <div class="form-row">
        <label for="node-input-selectedAddresses"><span>Selected Sellers</span></label>
        <textarea id="node-input-selectedAddresses" rows="3" readonly style="width: 100%;"></textarea>
    </div>
    <div class="form-row">
        <label for="node-input-description"> <span>Description</span></label>
        <input type="text" id="node-input-description" placeholder="Description (optional)">
    </div>
    
    <!-- Separator line between configuration and runtime information -->
    <hr style="margin: 15px 0; border: none; border-top: 1px solid #ccc;">
    
    <div class="form-row">
        <label for="node-input-evmAddress"><span>EVM</span></label>
        <input type="text" id="node-input-evmAddress" placeholder="EVM Address will appear here after initialization" readonly>
    </div>
    <div class="form-row">
        <label for="node-input-balance"><span>Balance</span></label>
        <input type="text" id="node-input-balance" placeholder="Account balance will appear here after initialization" readonly>
    </div>

    <!-- Connection Status Section - moved to bottom -->
    <div class="form-row">
        <label><span>Connection Status</span></label>
        <div id="connection-status-indicator" style="display: inline-block; margin-left: 10px;">
            <span id="status-dot" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #ccc; margin-right: 5px;"></span>
            <span id="status-text" style="color: white;">Unknown</span>
        </div>
        <button type="button" id="refresh-connections-btn" class="red-ui-button" style="margin-left: 10px;">
            <i class="fa fa-refresh"></i> Refresh
        </button>
    </div>
    
    <div class="form-row">
        <label><span>Connected Peers</span></label>
        <div id="connected-peers-container" style="margin-top: 10px;">
            <div id="peers-loading" style="text-align: center; color: black; padding: 20px;">
                <i class="fa fa-spinner fa-spin"></i> Loading connection status...
            </div>
            <div id="peers-content" style="display: none;">
                <div id="peers-summary" style="margin-bottom: 10px; font-weight: bold; color: white;">
                    <span id="connected-count">0</span> connected, <span id="total-count">0</span> total peers
                </div>
                <div id="peers-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f9f9f9;">
                    <div id="no-peers-message" style="text-align: center; color: black; font-style: italic;">
                        No peers connected
                    </div>
                    <table id="peers-table" style="width: 100%; display: none; color: black;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd; color: black;">Public Key</th>
                                <th style="text-align: center; padding: 5px; border-bottom: 1px solid #ddd; color: black;">Status</th>
                                <th style="text-align: center; padding: 5px; border-bottom: 1px solid #ddd; color: black;">Last Update</th>
                            </tr>
                        </thead>
                        <tbody id="peers-table-body">
                        </tbody>
                    </table>
                </div>
                <div id="last-update-info" style="margin-top: 5px; font-size: 12px; color: black;">
                    Last updated: <span id="last-update-time">Never</span>
                </div>
            </div>
        </div>
    </div>


    <div id="seller-modal" class="red-ui-dialog" style="display: none;" title="Select Seller Devices">
        <div class="red-ui-dialog-content" style="padding: 15px; overflow: hidden; display: flex; flex-direction: column; height: 100%;">
            <div style="margin-bottom: 15px;">
                <label for="seller-search-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Search by Contract Address:</label>
                <input type="text" id="seller-search-input" placeholder="Enter contract address to search..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>
            <div style="flex: 1; overflow: auto; margin-bottom: 15px;">
                <table id="seller-table" class="seller-table" style="width: 100%; border-collapse: collapse;">
                    <colgroup>
                        <col style="width: 80px;">  <!-- Select column -->
                        <col style="width: 25%;">   <!-- Contract column -->
                        <col style="width: 25%;">   <!-- StdOutTopic column -->
                        <col style="width: 25%;">   <!-- StdInTopic column -->
                        <col style="width: 25%;">   <!-- StdErrTopic column -->
                    </colgroup>
                    <thead>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <th style="text-align: left; padding: 8px 12px; font-weight: bold;">Select</th>
                            <th style="text-align: left; padding: 8px 12px; font-weight: bold;">Contract</th>
                            <th style="text-align: left; padding: 8px 12px; font-weight: bold;">StdOutTopic</th>
                            <th style="text-align: left; padding: 8px 12px; font-weight: bold;">StdInTopic</th>
                            <th style="text-align: left; padding: 8px 12px; font-weight: bold;">StdErrTopic</th>
                        </tr>
                    </thead>
                    <tbody style="display: table-row-group; overflow-y: auto; max-height: 300px;"></tbody>
                </table>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid #eee;">
                <button type="button" class="red-ui-button" id="cancel-seller-selection">Cancel</button>
                <button type="button" class="red-ui-button red-ui-button-primary" id="confirm-seller-selection">OK</button>
            </div>
        </div>
    </div>
</script>

<!-- Include connection status template -->
<script type="text/html" data-template-name="connection-status">
    <div class="form-row">
        <label><span>Connection Status</span></label>
        <div id="connection-status-indicator" style="display: inline-block; margin-left: 10px;">
            <span id="status-dot" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #ccc; margin-right: 5px;"></span>
            <span id="status-text">Unknown</span>
        </div>
        <button type="button" id="refresh-connections-btn" class="red-ui-button" style="margin-left: 10px;">
            <i class="fa fa-refresh"></i> Refresh
        </button>
    </div>
    
    <div class="form-row">
        <label><span>Connected Peers</span></label>
        <div id="connected-peers-container" style="margin-top: 10px;">
            <div id="peers-loading" style="text-align: center; color: #666; padding: 20px;">
                <i class="fa fa-spinner fa-spin"></i> Loading connection status...
            </div>
            <div id="peers-content" style="display: none;">
                <div id="peers-summary" style="margin-bottom: 10px; font-weight: bold; color: white;">
                    <span id="connected-count">0</span> connected, <span id="total-count">0</span> total peers
                </div>
                <div id="peers-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f9f9f9;">
                    <div id="no-peers-message" style="text-align: center; color: #666; font-style: italic;">
                        No peers connected
                    </div>
                    <table id="peers-table" style="width: 100%; display: none;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd;">Public Key</th>
                                <th style="text-align: center; padding: 5px; border-bottom: 1px solid #ddd;">Status</th>
                                <th style="text-align: center; padding: 5px; border-bottom: 1px solid #ddd;">Last Update</th>
                            </tr>
                        </thead>
                        <tbody id="peers-table-body">
                        </tbody>
                    </table>
                </div>
                <div id="last-update-info" style="margin-top: 5px; font-size: 12px; color: #666;">
                    Last updated: <span id="last-update-time">Never</span>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
    // Move shared variables/functions outside the IIFE


    RED.nodes.registerType('buyer config', {
        category: 'Neuron',
        color: '#9799b2',
        defaults: {
            name: { value: "Buyer"},
            sellerEvmAddress: { value: [] },
            sellerDevices: { value: [] },
            smartContract: { value: "jetvision" },
            deviceType: { value: null, required: true },
            description: { value: "" },
            evmAddress: { value: "" },
            balance: { value: "" }
        },
        inputs: 0,
        outputs: 0,
        icon: "serial.svg",
        label: function () {
            return this.name || "Neuron Buyer";
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            const node = this;
            // Make selectedDevices accessible to oneditsave
            this.selectedDevices = [];
            $('<style>')
                .text(`
                    .seller-table tr.selected {
                        background-color: #DDD;
                        color: black;
                       // outline: 2px solid #4d90fe;
                    }
                    .seller-table tr:hover {
                       outline: 2px solid #4d90fe;
                    }
                    .seller-table {
                        width: 100%;
                        border-collapse: collapse;
                        color: white;
                    }
                    .seller-table th, .seller-table td {
                        border: 1px solid #ccc;
                        padding: 8px;
                        text-align: left;
                        color: white;
                    }
                    .seller-table thead th {
                        position: sticky;
                        top: 0;
                        background-color: black;
                        color: white;
                        z-index: 1;
                    }
                `)
                .appendTo('head');

            //console.log(node.sellerEvmAddress);

            //  const selectedAddresses = JSON.parse(node.sellerEvmAddress || "[]");
            const selectedAddresses = typeof node.sellerEvmAddress === 'string'
                ? JSON.parse(node.sellerEvmAddress)
                : [];
            if (Array.isArray(selectedAddresses)) {
                // $('#node-input-sellerEvmAddress').val(JSON.stringify(node.sellerEvmAddress));
                $('#node-input-selectedAddresses').val(selectedAddresses.join('\n'));
            }
            // Function to load devices for the selected contract
            function loadDevicesForCurrentContract() {
                const selectedContract = $('#node-input-smartContract').val();
                console.log('Loading devices for contract:', selectedContract);
                
                $.get(`/buyer/devices?contract=${selectedContract}`)
                    .done(function(data) {
                        console.log('Devices loaded:', data);
                        const tableBody = $('#seller-table tbody');
                        tableBody.empty();
                        
                        if (data.loading) {
                            // Show loading message
                            tableBody.html(`
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #4d90fe;">
                                        <i class="fa fa-spinner fa-spin"></i> Loading devices for ${selectedContract} contract...
                                        <br><small>The global contract monitor is currently fetching data for this contract.</small>
                                    </td>
                                </tr>
                            `);
                            return;
                        }
                        
                        if (!data.monitoringActive) {
                            // Show monitoring inactive message
                            tableBody.html(`
                                <tr>
                                    <td colspan="5" style="text-align: center; color: orange;">
                                        <i class="fa fa-exclamation-triangle"></i> Global contract monitoring is not active.
                                        <br><small>Please restart Node-RED to initialize the global contract monitor.</small>
                                    </td>
                                </tr>
                            `);
                            return;
                        }
                        
                        if (data.devices && data.devices.length > 0) {
                            // Show devices in the table - all devices from global contract monitor are potential sellers
                            data.devices.forEach(device => {
                                console.log('Processing device:', device);
                                // Use the contract field (which is the owner address) for selection
                                const isChecked = node.sellerEvmAddress?.includes(device.contract);
                                const row = $(`
                                    <tr class="${isChecked ? "selected" : "not-selected"}" data-contract="${device.contract}">
                                        <td style="width: 50px; overflow: hidden; text-overflow: ellipsis;">
                                            <input type="checkbox" ${isChecked ? "checked" : ""}>
                                        </td>
                                        <td style="overflow: hidden; text-overflow: ellipsis;" title="${device.contract}">
                                            ${device.contract}
                                        </td>
                                        <td style="overflow: hidden; text-overflow: ellipsis;" title="${device.stdOutTopic}">
                                            ${device.stdOutTopic}
                                        </td>
                                        <td style="overflow: hidden; text-overflow: ellipsis;" title="${device.stdInTopic}">
                                            ${device.stdInTopic}
                                        </td>
                                        <td style="overflow: hidden; text-overflow: ellipsis;" title="${device.stdErrTopic}">
                                            ${device.stdErrTopic}
                                        </td>
                                    </tr>
                                `);

                                row.data('address', device.contract);
                                row.data('device', device);
                                tableBody.append(row);
                            });
                            
                            console.log(`Populated table with ${data.devices.length} devices for contract ${selectedContract}`);
                            
                            $('#seller-table tbody input[type="checkbox"]').change(function () {
                                const row = $(this).closest('tr');
                                if ($(this).is(':checked')) {
                                    row.addClass('selected');
                                } else {
                                    row.removeClass('selected');
                                }
                            });
                            
                            // restore from previous config
                            if (Array.isArray(node.sellerDevices)) {
                                node.selectedDevices.push(...node.sellerDevices);
                            }

                            if (Array.isArray(node.sellerEvmAddress)) {
                                $('#node-input-sellerEvmAddress').val(JSON.stringify(node.sellerEvmAddress));
                                $('#node-input-selectedAddresses').val(node.sellerEvmAddress.join('\n'));
                            }
                        } else {
                            // Show no devices message
                            tableBody.html(`
                                <tr>
                                    <td colspan="5" style="text-align: center; color: orange;">
                                        <i class="fa fa-info-circle"></i> No devices found for the selected contract.
                                        <br><small>There are no devices registered for the ${selectedContract} contract.</small>
                                        <br><small>Debug: Received ${data.devices ? data.devices.length : 0} devices from server.</small>
                                    </td>
                                </tr>
                            `);
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Failed to load devices:', error);
                        const tableBody = $('#seller-table tbody');
                        tableBody.html(`
                            <tr>
                                <td colspan="5" style="text-align: center; color: red;">
                                    <i class="fa fa-exclamation-triangle"></i> Failed to load devices.
                                    <br><small>Error: ${error}</small>
                                </td>
                            </tr>
                        `);
                    });
            }

            // Function to filter table rows based on search input
            function filterTableBySearch() {
                const searchTerm = $('#seller-search-input').val().toLowerCase().trim();
                const tableRows = $('#seller-table tbody tr');
                
                if (searchTerm === '') {
                    // Show all rows if search is empty
                    tableRows.show();
                    return;
                }
                
                let visibleCount = 0;
                tableRows.each(function() {
                    const row = $(this);
                    const contractAddress = row.data('contract') || '';
                    
                    if (contractAddress.toLowerCase().includes(searchTerm)) {
                        row.show();
                        visibleCount++;
                    } else {
                        row.hide();
                    }
                });
                
                // Show message if no results found
                if (visibleCount === 0) {
                    $('#seller-table tbody').append(`
                        <tr id="no-results-row" style="display: table-row;">
                            <td colspan="5" style="text-align: center; color: orange;">
                                <i class="fa fa-search"></i> No devices found matching "${searchTerm}"
                            </td>
                        </tr>
                    `);
                } else {
                    $('#no-results-row').remove();
                }
            }

            // Open modal on button click
            $('#select-sellers-btn').click(function () {
                if (!$("#seller-modal").data("ui-dialog")) {
                    $("#seller-modal").dialog({
                        autoopen: false,
                        modal: true,
                        width: '80%',
                        maxWidth: 600,
                        height: 'auto',
                        maxHeight: 600,
                        resizable: true,
                        position: { my: "center", at: "center", of: window }, // Add this line
                        close: function () {
                            $(this).dialog("destroy");
                        },
                        open: function() {
                            // Load devices for current contract when modal opens
                            loadDevicesForCurrentContract();
                            
                            // Attach event handlers after dialog is created
                            $('#cancel-seller-selection').off('click').on('click', function () {
                                $("#seller-modal").dialog("close");
                            });

                            $('#confirm-seller-selection').off('click').on('click', function () {
                                console.log('OK button clicked!');
                                const selectedAddresses = [];
                                const selectedDeviceObjects = [];

                                $('#seller-table tbody input[type=checkbox]:checked').each(function () {
                                    const row = $(this).closest('tr');
                                    const address = row.data('address');
                                    const device = row.data('device');
                                    selectedAddresses.push(address);
                                    selectedDeviceObjects.push(device);
                                });

                                console.log('Selected addresses:', selectedAddresses);
                                console.log('Selected devices:', selectedDeviceObjects);

                                $('#node-input-sellerEvmAddress').val(JSON.stringify(selectedAddresses));
                                $('#node-input-selectedAddresses').val(selectedAddresses.join('\n'));
                                node.selectedDevices.splice(0, node.selectedDevices.length, ...selectedDeviceObjects);
                                
                                $("#seller-modal").dialog("close");
                            });

                            // Attach search functionality
                            $('#seller-search-input').off('input').on('input', function() {
                                filterTableBySearch();
                            });
                        }
                    });
                } else {
                    $("#seller-modal").dialog("open");
                    // Load devices for current contract when modal is reopened
                    loadDevicesForCurrentContract();
                }

                // Adjust table height when dialog resizes
                $(window).on('resize.sellerDialog', function () {
                    const dialogContent = $('#seller-modal .red-ui-dialog-content');
                    const tbody = $('#seller-table tbody');
                    const headerHeight = $('#seller-table thead').outerHeight();
                    const footerHeight = 50; // Approximate height of button area
                    const padding = 30; // Additional padding

                    tbody.css('max-height',
                        Math.max(100, dialogContent.height() - headerHeight - footerHeight - padding)
                    );
                }).trigger('resize.sellerDialog');
            });

            // Add event listener for smart contract changes
            $('#node-input-smartContract').change(function() {
                console.log('Smart contract changed to:', $(this).val());
                // Refresh device list when contract changes
                if ($("#seller-modal").data("ui-dialog") && $("#seller-modal").dialog("isOpen")) {
                    // If modal is open, refresh the device list
                    loadDevicesForCurrentContract();
                }
            });

            // Initialize connection status display
            if (node.id) {
                // Initialize connection status functionality
                initializeBuyerConnectionStatus(node.id);
            }

            // Fetch and populate EVM address if available (ONE TIME ONLY - NO REFRESH)
            function updateEvmAddress() {
                if (node.id) {
                    console.log(`Fetching EVM address for node ID: ${node.id}`); // Debug log
                    $.get(`/buyer/device-info/${node.id}`)
                        .done(function(data) {
                            console.log(`EVM data received for ${node.id}:`, data); // Debug log
                            if (data.evmAddress) {
                                $('#node-input-evmAddress').val(data.evmAddress);
                            } else {
                                $('#node-input-evmAddress').val('Not initialized yet');
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error(`Failed to fetch EVM for ${node.id}:`, error); // Debug log
                            $('#node-input-evmAddress').val('Error loading EVM address');
                        });
                } else {
                    $('#node-input-evmAddress').val('New node - EVM address will be generated after deployment');
                }
            }

            // Fetch and populate device balance if available
            function updateDeviceBalance() {
                if (node.id) {
                    $.get(`/buyer/device-balance/${node.id}`)
                        .done(function(data) {
                            if (data.success && data.balance) {
                                $('#node-input-balance').val(data.balance + ' USDC');
                            } else {
                                $('#node-input-balance').val('Not initialized yet');
                            }
                        })
                        .fail(function() {
                            $('#node-input-balance').val('Error loading balance');
                        });
                } else {
                    $('#node-input-balance').val('New node - balance will be available after deployment');
                }
            }

            // Update EVM address ONCE on dialog open (NO REFRESH EVER)
            updateEvmAddress();
            
            // Update balance ONCE on dialog open (NO REFRESH)
            updateDeviceBalance();
        },
        

        oneditcancel: function() {
            // Clean up intervals when dialog is cancelled/closed
            if (this._cleanup) {
                this._cleanup();
            }
        },

        oneditsave: function () {
            // Clean up intervals when dialog is saved/closed
            if (this._cleanup) {
                this._cleanup();
            }
            
            // Get the selected addresses from the hidden input
            const sellerEvmAddressValue = $('#node-input-sellerEvmAddress').val();
            let selectedAddresses = [];
            
            if (sellerEvmAddressValue) {
                try {
                    selectedAddresses = JSON.parse(sellerEvmAddressValue);
                } catch (e) {
                    console.error('Failed to parse seller addresses:', e);
                    selectedAddresses = [];
                }
            }
            
            // Update the node configuration
            this.sellerEvmAddress = selectedAddresses;
            this.sellerDevices = this.selectedDevices;
            
            // Save the current EVM address and balance
            this.evmAddress = $('#node-input-evmAddress').val();
            this.balance = $('#node-input-balance').val();
        }
    });     

    // Connection status initialization function
    function initializeBuyerConnectionStatus(nodeId) {
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const refreshBtn = document.getElementById('refresh-connections-btn');
        const peersLoading = document.getElementById('peers-loading');
        const peersContent = document.getElementById('peers-content');
        const connectedCount = document.getElementById('connected-count');
        const totalCount = document.getElementById('total-count');
        const noPeersMessage = document.getElementById('no-peers-message');
        const peersTable = document.getElementById('peers-table');
        const peersTableBody = document.getElementById('peers-table-body');
        const lastUpdateTime = document.getElementById('last-update-time');

        let isRefreshing = false;

        function updateStatusIndicator(status) {
            // Remove all status classes
            statusDot.classList.remove('connection-status-connected', 'connection-status-disconnected', 'connection-status-connecting', 'connection-status-unknown');
            
            if (status.isConnected) {
                statusDot.classList.add('connection-status-connected');
                statusText.textContent = `Connected (${status.connectedPeers}/${status.totalPeers} peers)`;
            } else if (status.reconnectAttempts > 0) {
                statusDot.classList.add('connection-status-connecting');
                statusText.textContent = `Connecting... (${status.reconnectAttempts} attempts)`;
            } else {
                statusDot.classList.add('connection-status-disconnected');
                statusText.textContent = 'Disconnected';
            }
        }

        function updatePeersDisplay(status) {
            const peers = status.peers || [];
            const connectedPeers = peers.filter(p => p.connectionStatus === 'connected');
            
            // Update summary
            connectedCount.textContent = connectedPeers.length;
            totalCount.textContent = peers.length;
            
            // Show/hide content
            peersLoading.style.display = 'none';
            peersContent.style.display = 'block';
            
            if (peers.length === 0) {
                noPeersMessage.style.display = 'block';
                peersTable.style.display = 'none';
            } else {
                noPeersMessage.style.display = 'none';
                peersTable.style.display = 'table';
                
                // Clear existing rows
                peersTableBody.innerHTML = '';
                
                // Add peer rows
                peers.forEach(peer => {
                    const row = document.createElement('tr');
                    row.className = 'peers-table-row';
                    
                    const publicKeyCell = document.createElement('td');
                    publicKeyCell.className = 'peers-table-cell peer-public-key';
                    publicKeyCell.textContent = peer.publicKey || 'Unknown';
                    publicKeyCell.title = peer.publicKey || 'Unknown';
                    
                    const statusCell = document.createElement('td');
                    statusCell.className = 'peers-table-cell';
                    statusCell.style.textAlign = 'center';
                    const statusSpan = document.createElement('span');
                    statusSpan.textContent = peer.connectionStatus || 'unknown';
                    statusSpan.className = `peer-status-${peer.connectionStatus || 'unknown'}`;
                    statusCell.appendChild(statusSpan);
                    
                    const lastUpdateCell = document.createElement('td');
                    lastUpdateCell.className = 'peers-table-cell';
                    lastUpdateCell.style.textAlign = 'center';
                    lastUpdateCell.textContent = peer.lastUpdate ? new Date(peer.lastUpdate).toLocaleTimeString() : 'N/A';
                    
                    row.appendChild(publicKeyCell);
                    row.appendChild(statusCell);
                    row.appendChild(lastUpdateCell);
                    peersTableBody.appendChild(row);
                });
            }
            
            // Update last update time
            if (status.lastUpdate) {
                lastUpdateTime.textContent = new Date(status.lastUpdate).toLocaleString();
            } else {
                lastUpdateTime.textContent = 'Never';
            }
        }

        async function loadConnectionStatus() {
            try {
                const response = await fetch(`/buyer/connection-status/${nodeId}`);
                if (response.ok) {
                    const status = await response.json();
                    updateStatusIndicator(status);
                    updatePeersDisplay(status);
                } else {
                    console.error('Failed to load connection status:', response.statusText);
                    statusText.textContent = 'Error loading status';
                    statusDot.classList.add('connection-status-unknown');
                }
            } catch (error) {
                console.error('Error loading connection status:', error);
                statusText.textContent = 'Error loading status';
                statusDot.classList.add('connection-status-unknown');
            }
        }

        async function refreshConnections() {
            if (isRefreshing) return;
            
            isRefreshing = true;
            refreshBtn.classList.add('refresh-button-loading');
            
            try {
                const response = await fetch(`/buyer/refresh-connections/${nodeId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    updateStatusIndicator(result.status);
                    updatePeersDisplay(result.status);
                } else {
                    console.error('Failed to refresh connections:', response.statusText);
                }
            } catch (error) {
                console.error('Error refreshing connections:', error);
            } finally {
                isRefreshing = false;
                refreshBtn.classList.remove('refresh-button-loading');
            }
        }

        // Set up event listeners
        refreshBtn.addEventListener('click', refreshConnections);

        // Load initial status (single call only)
        loadConnectionStatus();

        // Remove the periodic refresh - no more polling
        // const statusInterval = setInterval(loadConnectionStatus, 30000);

        // Cleanup function (no interval to clear)
        return () => {
            refreshBtn.removeEventListener('click', refreshConnections);
        };
    }
</script>

<style>
.connection-status-connected { background-color: #4CAF50 !important; }
.connection-status-disconnected { background-color: #f44336 !important; }
.connection-status-connecting { background-color: #ff9800 !important; }
.connection-status-unknown { background-color: #9e9e9e !important; }
.peer-status-connected { color: #4CAF50; font-weight: bold; }
.peer-status-disconnected { color: #f44336; font-weight: bold; }
.peer-status-unknown { color: #9e9e9e; font-weight: bold; }
.peers-table-row { border-bottom: 1px solid #eee; color: black; }
.peers-table-row:hover { background-color: #f5f5f5; }
.peers-table-cell { padding: 8px 5px; vertical-align: middle; color: black; }
.peer-public-key { font-family: monospace; font-size: 11px; word-break: break-all; max-width: 200px; color: black; }
.refresh-button-loading { opacity: 0.6; pointer-events: none; }
.refresh-button-loading i { animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>


<script type="text/x-red" data-help-name="buyer">
    <p>A node that handles buyer functionality in the Neuron network.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>The input message containing transaction details.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>The output message containing processed transaction data.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node provides the following functionality:</p>
    <ul>
        <li>Connects to the Neuron network as a buyer node</li>
        <li>Handles transaction processing and validation</li>
        <li>Manages communication with seller nodes</li>
        <li>Provides real-time status updates</li>
    </ul>
    <h3>Configuration</h3>
    <ul>
        <li><b>Name</b>: A unique identifier for this node</li>
        <li><b>Node Type</b>: Select between buyer or seller mode</li>
        <li><b>Selected Node</b>: Choose a specific node to interact with</li>
    </ul>
    <h3>Usage Notes</h3>
    <ul>
        <li>Ensure proper network connectivity before deployment</li>
        <li>Monitor the node status for connection issues</li>
        <li>Check the debug output for detailed transaction logs</li>
        <li>Use the status indicator to verify node health</li>
    </ul>
    <h3>Message Format</h3>
    <p>The node expects messages in the following format:</p>
    <pre>
{
    "type": "transaction",
    "data": {
        "amount": number,
        "currency": string,
        "recipient": string
    }
}
    </pre>
    <h3>Status Indicators</h3>
    <ul>
        <li><span style="color:green">●</span> Connected: Node is active and connected</li>
        <li><span style="color:red">●</span> Disconnected: Node is offline</li>
        <li><span style="color:yellow">●</span> Processing: Transaction in progress</li>
    </ul>
</script>